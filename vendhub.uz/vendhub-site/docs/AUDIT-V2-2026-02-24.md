# VendHub.uz — Повторный аудит (V2)

> **Дата:** 24 февраля 2026
> **Аудитор:** Claude (по запросу Jamshid)
> **Тип:** Повторная проверка после исправлений
> **Проект:** vendhub-site (Next.js 16 + React 19 + Supabase)

---

## Результаты автоматических проверок

| Проверка | Статус |
|----------|--------|
| TypeScript (`tsc --noEmit`) | **PASS** — 0 ошибок |
| ESLint (`pnpm lint`) | **PASS** — 0 ошибок, 2 предупреждения (admin `<img>` вместо `<Image>`) |
| Build (`next build`) | **PASS** — все страницы собираются |
| Dependencies | **OK** — 401 пакет, 0 уязвимостей |

**Предупреждение при build:** Next.js 16.1.6 помечает `middleware.ts` как deprecated.

---

## ИСПРАВЛЕНО С ПЕРВОГО АУДИТА (✅ 14 пунктов)

Следующие проблемы из первого аудита **уже исправлены** — подтверждено повторной проверкой кода:

| # | Проблема (V1) | Статус | Подтверждение |
|---|---------------|--------|---------------|
| 1 | Sitemap с якорями (#) | ✅ Исправлено | `sitemap.ts` — только `/` с hreflang alternates, якорей нет |
| 3 | ProductModal падает при пустых options | ✅ Исправлено | Строка 40: `product.options[0] ?? fallbackOption` (fallback на строках 33-37) |
| 5 | Yandex Maps ссылка в AboutSection | ✅ Исправлено | Строка 50: `https://www.google.com/maps/search/...` вместо Yandex |
| 7 | Header — IntersectionObserver без cleanup | ✅ Исправлено | Строка 67: `return () => observers.forEach((obs) => obs.disconnect())` |
| 8 | Фильтры Snack/Cold с нулевым количеством | ✅ Исправлено | Кнопки скрываются когда `count === 0` |
| 9a | PromoBanner — hardcoded строки | ✅ Исправлено | Использует `useTranslations('promoBanner')` |
| 9b | PopularProducts — hardcoded строки | ✅ Исправлено | Использует `useTranslations('popularProducts')` |
| 9c | WhyVendHub — hardcoded строки | ✅ Исправлено | Использует `useTranslations('whyVendHub')` с ключами |
| 9d | StatsSection — hardcoded строки | ✅ Исправлено | Использует `useTranslations('stats')` |
| 15 | YANDEX_MAPS_API_KEY в CI | ✅ Исправлено | Убрана из `.github/workflows/ci.yml` |
| 17 | Toast без `role="alert"` | ✅ Исправлено | Строка 57: `role="alert"` добавлен |
| 18 | Header — кнопка меню без `aria-expanded` | ✅ Исправлено | Строка 182: `aria-expanded={isMobileMenuOpen}` |
| 19 | ProductModal — кнопки без `aria-pressed` | ✅ Исправлено | Строки 145, 172: `aria-pressed={selectedOption === opt}` |
| 14 | CATEGORY_GRADIENT несоответствие | ✅ Проверено | Вынесены в `lib/categoryStyles.ts` — единый источник |

---

## ОСТАВШИЕСЯ ПРОБЛЕМЫ

### КРИТИЧЕСКИЕ (3)

#### К1. LeafletMap — `useMemo` используется как side effect

**Файл:** `components/map/LeafletMap.tsx`, строка 59

```typescript
useMemo(() => {
  const points = machines
    .filter((m) => m.latitude != null && m.longitude != null)
    .map((m) => [m.latitude!, m.longitude!] as L.LatLngTuple)

  if (points.length > 1) {
    map.fitBounds(L.latLngBounds(points), { padding: [40, 40], maxZoom: 14 })
  } else if (points.length === 1) {
    map.setView(points[0], 14)
  }
}, [machines, map])
```

**Проблема:** `useMemo` предназначен для мемоизации значений, а не для побочных эффектов. Вызовы `map.fitBounds()` и `map.setView()` — это side effects. React может пропустить или повторить вычисление `useMemo` по своему усмотрению, что приведёт к непредсказуемому поведению карты.

**Решение:** Заменить `useMemo` на `useEffect`:
```typescript
useEffect(() => {
  const points = machines
    .filter((m) => m.latitude != null && m.longitude != null)
    .map((m) => [m.latitude!, m.longitude!] as L.LatLngTuple)
  if (points.length > 1) {
    map.fitBounds(L.latLngBounds(points), { padding: [40, 40], maxZoom: 14 })
  } else if (points.length === 1) {
    map.setView(points[0], 14)
  }
}, [machines, map])
```

---

#### К2. Toast — setTimeout всё ещё без cleanup

**Файл:** `components/ui/Toast.tsx`, строки 41-43

```typescript
const showToast = useCallback((message: string, type: ToastType = 'info') => {
  const id = ++toastId
  setToasts((prev) => [...prev, { id, message, type }])
  setTimeout(() => {
    setToasts((prev) => prev.filter((t) => t.id !== id))
  }, 3000)
}, [])
```

**Проблема:** `setTimeout` вызывается внутри `useCallback`, а не внутри `useEffect`. Если `ToastProvider` unmount'ится (навигация SPA), таймеры продолжают работать и вызывают `setToasts` на unmounted компоненте. Это потенциальная утечка памяти.

**Решение:** Хранить ID таймеров и очищать при unmount:
```typescript
const timersRef = useRef<Map<number, ReturnType<typeof setTimeout>>>(new Map())

const showToast = useCallback((message: string, type: ToastType = 'info') => {
  const id = ++toastId
  setToasts((prev) => [...prev, { id, message, type }])
  const timer = setTimeout(() => {
    setToasts((prev) => prev.filter((t) => t.id !== id))
    timersRef.current.delete(id)
  }, 3000)
  timersRef.current.set(id, timer)
}, [])

// Cleanup при unmount
useEffect(() => {
  return () => {
    timersRef.current.forEach((timer) => clearTimeout(timer))
    timersRef.current.clear()
  }
}, [])
```

---

#### К3. not-found.tsx — билингвальный хардкод, ссылка без локали

**Файл:** `app/not-found.tsx`

**Проблемы:**
1. Текст на строках 13, 16, 23 захардкожен билингвально: `"Sahifa topilmadi / Страница не найдена"`. Это не i18n — просто два языка в одной строке.
2. Ссылка на строке 19: `href="/"` — всегда ведёт на русскую версию, даже если пользователь был на `/uz/`.
3. `not-found.tsx` находится на root уровне (вне `[locale]/`), поэтому `useTranslations()` недоступен.

**Решение:** Поскольку `not-found.tsx` в App Router на root уровне не имеет доступа к locale, есть два варианта:

**Вариант A (простой):** Определять язык из `navigator.language` или HTTP-заголовка на клиенте:
```typescript
'use client'
import { useEffect, useState } from 'react'

export default function NotFound() {
  const [isUz, setIsUz] = useState(false)
  useEffect(() => {
    setIsUz(window.location.pathname.startsWith('/uz'))
  }, [])

  const href = isUz ? '/uz' : '/'
  const title = isUz ? 'Sahifa topilmadi' : 'Страница не найдена'
  // ...
}
```

**Вариант B (лучше):** Создать `app/[locale]/not-found.tsx` с полноценным i18n.

---

### ВАЖНЫЕ (7)

#### В1. AboutSection — tel: ссылка формируется некорректно

**Файл:** `components/sections/AboutSection.tsx`, строка 25

```typescript
href: `tel:${getContent('phone').replace(/\s/g, '')}`,
```

**Проблема:** `replace(/\s/g, '')` удаляет только пробелы, но оставляет скобки `()` и дефисы `-`. Если номер хранится как `+998 (71) 200-39-99`, результат будет `tel:+998(71)200-39-99` — некорректный формат.

**Решение:** `replace(/[^\d+]/g, '')` — удалить всё кроме цифр и `+`.

---

#### В2. PartnerSection — Supabase запросы без error handling

**Файл:** `components/sections/PartnerSection.tsx`, строки 46-69

```typescript
supabase.from('site_content').select('key, value').eq('section', 'partnership')
  .then(({ data }) => { ... })  // нет .catch()

supabase.from('partners').select('*').order('sort_order', { ascending: true })
  .then(({ data }) => { ... })  // нет .catch()
```

**Проблема:** Если Supabase недоступен или произошла сетевая ошибка, promise reject'ится без обработки. Это вызовет `Unhandled Promise Rejection` в консоли.

**Решение:** Добавить `.catch()` или обернуть в `try/catch` с async/await:
```typescript
useEffect(() => {
  supabase.from('site_content')
    .select('key, value')
    .eq('section', 'partnership')
    .then(({ data, error }) => {
      if (error) { console.error('CMS fetch error:', error); return }
      if (data) { /* ... */ }
    })
    .catch((err) => console.error('CMS network error:', err))
  // аналогично для partners
}, [])
```

---

#### В3. PartnerSection — `t.raw()` cast без валидации

**Файл:** `components/sections/PartnerSection.tsx`, строка 94

```typescript
return t.raw(`models.${key}.benefits`) as string[]
```

**Проблема:** `t.raw()` возвращает `unknown`. Прямой cast `as string[]` небезопасен — если в `messages/*.json` значение окажется строкой или объектом вместо массива, `.map()` на строке 143 вызовет ошибку.

**Решение:** Добавить runtime-проверку:
```typescript
const raw = t.raw(`models.${key}.benefits`)
return Array.isArray(raw) ? raw : []
```

---

#### В4. PromotionsTab — `navigator.clipboard` без fallback

**Файл:** `components/benefits/PromotionsTab.tsx`, строка 21

```typescript
function copyPromoCode(code: string) {
  navigator.clipboard.writeText(code)
  showToast(t('copied'), 'success')
}
```

**Проблема:** `navigator.clipboard.writeText()` может быть недоступен в старых браузерах или в insecure context (HTTP вместо HTTPS). Вызов без catch приведёт к `TypeError`.

**Решение:**
```typescript
async function copyPromoCode(code: string) {
  try {
    await navigator.clipboard.writeText(code)
    showToast(t('copied'), 'success')
  } catch {
    // Fallback: создать временный textarea
    const textarea = document.createElement('textarea')
    textarea.value = code
    document.body.appendChild(textarea)
    textarea.select()
    document.execCommand('copy')
    document.body.removeChild(textarea)
    showToast(t('copied'), 'success')
  }
}
```

---

#### В5. Footer — placeholder ссылки `href="#"`

**Файл:** `components/sections/Footer.tsx`, строки 172, 176

```html
<a href="#" ...>{t('privacy')}</a>
<a href="#" ...>{t('terms')}</a>
```

**Проблема:** Ссылки на «Политику конфиденциальности» и «Условия использования» ведут в никуда. Для коммерческого сайта в UZ это юридическое требование — нужны реальные страницы.

**Решение:** Создать `/privacy` и `/terms` страницы или временно скрыть ссылки.

---

#### В6. Dockerfile — мёртвая переменная YANDEX_MAPS_API_KEY

**Файл:** `Dockerfile`, строки 18, 21

```dockerfile
ARG NEXT_PUBLIC_YANDEX_MAPS_API_KEY=placeholder
ENV NEXT_PUBLIC_YANDEX_MAPS_API_KEY=$NEXT_PUBLIC_YANDEX_MAPS_API_KEY
```

**Проблема:** Проект перешёл на Leaflet + OSM. Yandex Maps переменная больше не используется нигде в коде, но осталась в Dockerfile.

**Решение:** Удалить обе строки.

---

#### В7. error.tsx и not-found.tsx — текст не через i18n

**Файлы:** `app/error.tsx`, `app/not-found.tsx`

**Проблема:** Оба файла показывают билингвальный текст в формате `"Узб / Рус"` вместо использования i18n. Пользователь видит оба языка одновременно, что выглядит непрофессионально.

**Решение:** Для `error.tsx` (внутри `[locale]/` layout) — использовать `useTranslations()`. Для `not-found.tsx` (root level) — определять locale через URL (см. К3).

---

### СРЕДНИЕ (8)

#### С1. LeafletMap — inline HTML с onmouseenter/onmouseleave

**Файл:** `components/map/LeafletMap.tsx`, строки 27-36, 78-90

```typescript
html: `<div ... onmouseenter="this.style.transform='scale(1.2)'"
   onmouseleave="this.style.transform='scale(1)'"
>☕</div>`,
```

**Проблема:** Inline event handlers в HTML-строке — это паттерн, уязвимый к XSS. Хотя здесь данные контролируемые (только `status`), это плохая практика. Также inline `<style>` в `USER_ICON` (строка 84-89) добавляется в DOM при каждом рендере.

**Решение:** Использовать CSS-классы вместо inline стилей и обработчиков. Вынести `@keyframes userPulse` в `globals.css`.

---

#### С2. Header — scroll listener пересоздаётся при каждом toggle меню

**Файл:** `components/sections/Header.tsx`, строка 41

```typescript
useEffect(() => {
  const handleScroll = () => {
    setIsScrolled(window.scrollY > 50)
    if (isMobileMenuOpen) {
      setIsMobileMenuOpen(false)
    }
  }
  window.addEventListener('scroll', handleScroll, { passive: true })
  return () => window.removeEventListener('scroll', handleScroll)
}, [isMobileMenuOpen])  // ← перезапуск при каждом открытии/закрытии меню
```

**Проблема:** Зависимость `[isMobileMenuOpen]` вызывает remove/add listener при каждом toggle. Это не баг, но лишняя работа.

**Решение:** Использовать `useRef` для `isMobileMenuOpen` внутри эффекта:
```typescript
const isMobileMenuOpenRef = useRef(isMobileMenuOpen)
isMobileMenuOpenRef.current = isMobileMenuOpen

useEffect(() => {
  const handleScroll = () => {
    setIsScrolled(window.scrollY > 50)
    if (isMobileMenuOpenRef.current) setIsMobileMenuOpen(false)
  }
  window.addEventListener('scroll', handleScroll, { passive: true })
  return () => window.removeEventListener('scroll', handleScroll)
}, []) // ← пустой массив, listener создаётся один раз
```

---

#### С3. LoyaltyTab — таблица без accessibility атрибутов

**Файл:** `components/benefits/LoyaltyTab.tsx`

**Проблема:** Таблица привилегий не имеет `<caption>`, заголовки без `scope="col"`. Скрин-ридерам сложно навигировать.

---

#### С4. MachinesSection — фильтры без `aria-label`

**Файл:** `components/sections/MachinesSection.tsx`

**Проблема:** Кнопки-фильтры (Все, Coffee, Combo, Snack, Cold) и кнопки статуса (online/offline) не имеют `aria-label` для скрин-ридеров.

---

#### С5. MenuSection — hover cursor для unavailable продуктов

**Файл:** `components/sections/MenuSection.tsx`

**Проблема:** Карточки продуктов с `available: false` имеют `hover` prop и `cursor-pointer`, что вводит в заблуждение — пользователь думает, что может кликнуть.

---

#### С6. Все изображения null в fallback-данных

**Файл:** `lib/data.ts`

**Проблема:** Все 20 продуктов, 16 автоматов и 4 партнёра имеют `image_url: null`. Без подключения Supabase с реальными данными сайт показывает только emoji.

**Примечание:** Это не баг — fallback работает корректно. Но для production обязательно загрузить реальные фото через админку.

---

#### С7. data.ts — несоответствие комментариев

**Файл:** `lib/data.ts`

**Проблемы:**
- Строка 18: комментарий `// PRODUCTS (20 total)` — реально 20, но CLAUDE.md говорит "22 реальных". Нужно синхронизировать.
- Партнёров 4 в массиве, но ранее упоминалось 5.

---

#### С8. PromotionsTab — formatDate всегда использует `ru-RU`

**Файл:** `components/benefits/PromotionsTab.tsx`, строка 31

```typescript
function formatDate(dateStr: string) {
  const d = new Date(dateStr)
  return d.toLocaleDateString('ru-RU', { ... })
}
```

**Проблема:** Локаль даты захардкожена как `ru-RU`. Для узбекского интерфейса дата тоже будет на русском.

**Решение:** Использовать `useLocale()` из next-intl для определения текущей локали.

---

## ОБНОВЛЁННЫЙ ПЛАН ИСПРАВЛЕНИЙ

### Этап 1 — Критические фиксы (1 день)

| # | Задача | Файл | Сложность |
|---|--------|------|-----------|
| 1 | Заменить `useMemo` на `useEffect` в FitBounds | `LeafletMap.tsx:59` | Низкая |
| 2 | Добавить cleanup для setTimeout в Toast | `Toast.tsx:37-44` | Низкая |
| 3 | Исправить not-found.tsx — определять locale | `app/not-found.tsx` | Средняя |
| 4 | Исправить tel: regex в AboutSection | `AboutSection.tsx:25` | Низкая |
| 5 | Удалить YANDEX_MAPS_API_KEY из Dockerfile | `Dockerfile:18,21` | Низкая |

### Этап 2 — Важные фиксы (1-2 дня)

| # | Задача | Файл | Сложность |
|---|--------|------|-----------|
| 6 | Добавить error handling в PartnerSection | `PartnerSection.tsx:46-69` | Низкая |
| 7 | Валидировать `t.raw()` в getModelBenefits | `PartnerSection.tsx:94` | Низкая |
| 8 | Clipboard fallback в PromotionsTab | `PromotionsTab.tsx:21` | Низкая |
| 9 | Заменить placeholder href="#" в Footer | `Footer.tsx:172,176` | Средняя |
| 10 | Перевести error.tsx на i18n | `app/error.tsx` | Низкая |
| 11 | Локализовать formatDate | `PromotionsTab.tsx:31` | Низкая |

### Этап 3 — Средние фиксы (1-2 дня)

| # | Задача | Файл | Сложность |
|---|--------|------|-----------|
| 12 | Вынести @keyframes из inline в globals.css | `LeafletMap.tsx`, `globals.css` | Низкая |
| 13 | Оптимизировать scroll listener в Header | `Header.tsx:29-41` | Низкая |
| 14 | Добавить caption/scope в таблицу LoyaltyTab | `LoyaltyTab.tsx` | Низкая |
| 15 | Добавить aria-label к фильтрам MachinesSection | `MachinesSection.tsx` | Низкая |
| 16 | Убрать hover для unavailable в MenuSection | `MenuSection.tsx` | Низкая |
| 17 | Синхронизировать кол-во продуктов в data.ts | `lib/data.ts`, `CLAUDE.md` | Низкая |

### Этап 4 — Инфраструктура (когда будет время)

| # | Задача | Файл | Сложность |
|---|--------|------|-----------|
| 18 | Исследовать миграцию middleware→proxy | `middleware.ts` | Высокая |
| 19 | Загрузить реальные фото продуктов | Через админку | Средняя |
| 20 | Создать страницы /privacy и /terms | `app/[locale]/` | Средняя |

---

## ПРЕДЛОЖЕНИЯ ПО УЛУЧШЕНИЮ (сохранены из V1)

### A. SEO — Создание отдельных страниц (высокий приоритет)

Сейчас весь сайт — это одна SPA-страница с якорями. Для SEO рекомендуется создать отдельные страницы: `/machines`, `/menu`, `/promotions`, `/cooperation`. Каждая получит свой `<title>`, `<meta description>` и будет индексироваться отдельно.

### B. Performance — Server Components

Перенести загрузку данных в Server Components (React 19) вместо клиентского Supabase SDK. Это ускорит First Contentful Paint и улучшит SEO (данные в HTML).

### C. Реальные изображения продуктов

Все 20 продуктов показывают emoji вместо фото. ImageUpload в админке уже готов — нужно сфотографировать напитки и загрузить.

### D. Loading states (Skeleton UI)

Добавить `loading.tsx` для основных маршрутов с skeleton-заглушками.

### E. PWA (Progressive Web App)

`manifest.json` + service worker для offline-доступа и push-уведомлений. Особенно актуально для мобильных пользователей в Узбекистане.

### F. Analytics

Yandex Metrika или Google Analytics с отслеживанием конверсий (клик «Войти» → Telegram Mini App).

### G. Тесты

Проект не имеет ни одного теста. Минимум: Vitest для утилит, React Testing Library для компонентов, Playwright для E2E.

### H. Мониторинг и логирование

Sentry для отлова ошибок в production + health-check endpoint для Railway.

### I. Open Graph изображения

Добавить `og:image` для красивого превью при шаринге в мессенджерах (особенно Telegram — основной канал для VendHub).

### J. Structured Data (JSON-LD)

Расширить JSON-LD разметку: добавить `Menu`, `Product`, `Place` для автоматов. Это улучшит сниппеты в поисковой выдаче.

---

## Итого V2

| Категория | V1 (было) | V2 (сейчас) |
|-----------|-----------|-------------|
| ✅ Исправлено | — | 14 |
| Критические проблемы | 6 | **3** |
| Важные проблемы | 10 | **7** |
| Средние проблемы | 12 | **8** |
| Предложения по улучшению | 10 | **10** |
| **Всего оставшихся** | **38** | **18 + 10 предложений** |

**Вывод:** Проект значительно улучшился с первого аудита. 14 из 28 проблем исправлены. Основные оставшиеся проблемы: `useMemo` side effect в карте, Toast cleanup, not-found.tsx без locale. Все они имеют низкую-среднюю сложность и могут быть исправлены за 1-2 дня.
