# VendHub.uz — Полный аудит проекта

> **Дата:** 24 февраля 2026
> **Аудитор:** Claude (по запросу Jamshid)
> **Проект:** vendhub-site (Next.js 16 + React 19 + Supabase)

---

## Результаты автоматических проверок

| Проверка | Статус |
|----------|--------|
| TypeScript (`tsc --noEmit`) | **PASS** — 0 ошибок |
| ESLint (`pnpm lint`) | **PASS** — 0 предупреждений |
| Build (`next build`) | **PASS** — все страницы собираются |
| Dependencies | **OK** — 401 пакет, 0 уязвимостей |

**Предупреждение при build:** Next.js 16.1.6 помечает `middleware.ts` как deprecated — рекомендуется миграция на `proxy`.

---

## КРИТИЧЕСКИЕ ПРОБЛЕМЫ (6)

### 1. Sitemap содержит якоря (#) вместо реальных URL

**Файл:** `app/sitemap.ts`

Поисковые системы (Google, Yandex) **игнорируют** фрагменты `#section` в URL. Все записи с якорями (`/#map`, `/#menu`, `/#benefits`, `/#partner`, `/#about`) не индексируются.

**Решение:** Убрать якоря из sitemap, оставив только `/` и `/uz/`. Либо создать отдельные SSR-страницы для каждого раздела (`/menu`, `/machines` и т.д.) — это значительно улучшит SEO.

---

### 2. not-found.tsx теряет локаль пользователя

**Файл:** `app/not-found.tsx`

Ссылка «Вернуться на главную» ведёт на `/` (русский) для всех пользователей, включая тех, кто был на узбекской версии `/uz/`. Текст страницы захардкожен на русском без i18n.

**Решение:** Использовать `useLocale()` из next-intl для определения текущего языка и корректной ссылки.

---

### 3. ProductModal падает при пустых options

**Файл:** `components/modals/ProductModal.tsx`

Если у продукта `options: []` (пустой массив), `selectedOption = product.options[0]` будет `undefined`. Дальнейшие обращения к `selectedOption.price` и `selectedOption.name` вызовут `TypeError: Cannot read properties of undefined`.

**Решение:** Добавить guard: `const selectedOption = product.options[0] ?? { name: product.name, price: product.price, temperature: product.temperature }`.

---

### 4. Toast — утечка памяти от orphaned setTimeout

**Файл:** `components/ui/Toast.tsx`

`setTimeout` создаётся для каждого toast, но нет cleanup при unmount компонента. Если пользователь быстро переключается между страницами, таймеры накапливаются.

**Решение:** Использовать `useEffect` с return cleanup функцией для каждого таймера.

---

### 5. Yandex Maps ссылка в AboutSection

**Файл:** `components/sections/AboutSection.tsx`

Несмотря на решение использовать Leaflet + OSM, в секции «О нас» осталась ссылка на Yandex Maps для открытия адреса. Несоответствие архитектурному решению.

**Решение:** Заменить на OpenStreetMap ссылку или Google Maps как универсальный навигатор.

---

### 6. middleware.ts deprecated в Next.js 16

**Предупреждение build:** `The "middleware" file convention is deprecated. Please use "proxy" instead.`

В будущих версиях Next.js middleware может быть удалён. Нужна миграция на новый proxy API.

**Решение:** Следить за документацией Next.js 16 и планировать миграцию на `proxy`.

---

## ВАЖНЫЕ ПРОБЛЕМЫ (10)

### 7. Header — IntersectionObserver без cleanup

**Файл:** `components/sections/Header.tsx`

Observer создаётся в `useEffect`, но при unmount не вызывается `observer.disconnect()`. Потенциальная утечка памяти.

### 8. MachinesSection — фильтры Snack/Cold с нулевым количеством

**Файл:** `components/sections/MachinesSection.tsx`

Кнопки-фильтры для типов «Snack» и «Cold» показывают `(0)`, но остаются кликабельными. Пользователь нажимает — получает пустой результат.

### 9. Hardcoded строки без i18n (6+ компонентов)

Следующие компоненты содержат русские строки вместо `useTranslations()`:

- `PromoBanner.tsx` — «Второй кофе -50%», описание
- `PopularProducts.tsx` — «Популярные товары», «Нажмите для подробностей»
- `WhyVendHub.tsx` — все 4 блока «Почему VendHub?»
- `StatsSection.tsx` — заголовки статистики
- `app/error.tsx` — текст ошибки
- `app/not-found.tsx` — текст 404

### 10. PartnerSection — нет error handling для Supabase

**Файл:** `components/partner/PartnerSection.tsx`

Запросы к Supabase не обёрнуты в try/catch. Если API недоступен, компонент может упасть.

### 11. AboutSection — tel: ссылка неправильно формируется

**Файл:** `components/sections/AboutSection.tsx`

`replace(/\s/g, '')` удаляет пробелы, но оставляет скобки и дефисы. Правильнее: `replace(/[^\d+]/g, '')`.

### 12. MachineModal — нет проверки координат GPS

**Файл:** `components/modals/MachineModal.tsx`

Координаты проверяются на `!= null`, но не на валидность (широта 37-46 для Узбекистана). Невалидные координаты сломают навигатор.

### 13. Статистика захардкожена в 3 местах

Значения «16 автоматов», «25+ напитков» дублируются в:
- `StatsSection.tsx`
- `WhyVendHub.tsx`
- `lib/data.ts`

Рассинхронизация неизбежна при обновлении данных.

### 14. CATEGORY_GRADIENT несоответствие

Градиенты для категории `snack` различаются:
- `MenuSection.tsx`: `'from-purple-100 to-violet-50'`
- `PopularProducts.tsx`: `'from-emerald-100 to-green-50'`

### 15. CI/CD — устаревшая env переменная

**Файл:** `.github/workflows/ci.yml`

Build использует `NEXT_PUBLIC_YANDEX_MAPS_API_KEY` (placeholder), хотя проект перешёл на Leaflet + OSM. Мёртвый код.

### 16. Все изображения null в data.ts

Все продукты, автоматы и партнёры в fallback-данных имеют `image_url: null` / `logo_url: null`. Сайт всегда показывает emoji-fallback вместо реальных фото.

---

## СРЕДНИЕ ПРОБЛЕМЫ (12)

### Accessibility

17. **Toast** — нет `role="alert"` для скрин-ридеров
18. **Header** — кнопка мобильного меню без `aria-expanded`
19. **ProductModal** — кнопки опций без `aria-pressed`
20. **LoyaltyTab** — таблица без `<caption>` и `scope` атрибутов
21. **MachinesSection** — фильтры без `aria-label`
22. **MenuSection** — grid без `role="grid"`

### Performance

23. **Header** — IntersectionObserver пересоздаётся при каждом рендере для всех секций
24. **MenuSection** — Card с `hover` prop для unavailable продуктов (misleading cursor)
25. **MachineModal** — `useProductsData()` вызывается без проверки на undefined

### Error handling

26. **LoyaltyTab** — `privileges` парсится без валидации типов
27. **PromotionsTab** — `navigator.clipboard.writeText()` без fallback для старых браузеров
28. **LanguageSwitcher** — нет fallback для неизвестных локалей

---

## ПЛАН ИСПРАВЛЕНИЙ

### Этап 1 — Критические фиксы (1-2 дня)

| # | Задача | Файлы | Сложность |
|---|--------|-------|-----------|
| 1 | Исправить sitemap — убрать якоря | `app/sitemap.ts` | Низкая |
| 2 | Исправить not-found.tsx — добавить i18n | `app/not-found.tsx` | Низкая |
| 3 | Защитить ProductModal от пустых options | `components/modals/ProductModal.tsx` | Низкая |
| 4 | Исправить Toast — cleanup setTimeout | `components/ui/Toast.tsx` | Низкая |
| 5 | Заменить Yandex Maps ссылку | `components/sections/AboutSection.tsx` | Низкая |
| 6 | Исправить tel: формирование | `components/sections/AboutSection.tsx` | Низкая |

### Этап 2 — i18n и консистентность (2-3 дня)

| # | Задача | Файлы | Сложность |
|---|--------|-------|-----------|
| 7 | Перевести PromoBanner на i18n | `PromoBanner.tsx`, `messages/*.json` | Низкая |
| 8 | Перевести PopularProducts на i18n | `PopularProducts.tsx`, `messages/*.json` | Низкая |
| 9 | Перевести WhyVendHub на i18n | `WhyVendHub.tsx`, `messages/*.json` | Средняя |
| 10 | Перевести StatsSection на i18n | `StatsSection.tsx`, `messages/*.json` | Низкая |
| 11 | Перевести error.tsx на i18n | `app/error.tsx` | Низкая |
| 12 | Унифицировать CATEGORY_GRADIENT | `MenuSection.tsx`, `PopularProducts.tsx` | Низкая |
| 13 | Вынести статистику в единый источник | `lib/data.ts`, секции | Средняя |

### Этап 3 — Accessibility и UX (2-3 дня)

| # | Задача | Файлы | Сложность |
|---|--------|-------|-----------|
| 14 | Добавить aria-атрибуты в Header | `Header.tsx` | Низкая |
| 15 | Добавить role="alert" в Toast | `Toast.tsx` | Низкая |
| 16 | Добавить caption/scope в таблицы | `LoyaltyTab.tsx` | Низкая |
| 17 | Добавить aria-pressed в ProductModal | `ProductModal.tsx` | Низкая |
| 18 | Отключить hover для unavailable | `MenuSection.tsx` | Низкая |
| 19 | Добавить error handling в PartnerSection | `PartnerSection.tsx` | Средняя |

### Этап 4 — Инфраструктура (1-2 дня)

| # | Задача | Файлы | Сложность |
|---|--------|-------|-----------|
| 20 | Убрать YANDEX_MAPS_API_KEY из CI | `.github/workflows/ci.yml` | Низкая |
| 21 | Исследовать миграцию middleware→proxy | `middleware.ts` | Высокая |
| 22 | Cleanup IntersectionObserver в Header | `Header.tsx` | Низкая |
| 23 | Clipboard fallback в PromotionsTab | `PromotionsTab.tsx` | Низкая |

---

## ПРЕДЛОЖЕНИЯ ПО УЛУЧШЕНИЮ

### A. SEO — Создание отдельных страниц (высокий приоритет)

Сейчас весь сайт — это одна SPA-страница с якорями. Для SEO рекомендуется создать отдельные страницы:

- `/machines` — страница автоматов с картой
- `/menu` — полный каталог продуктов
- `/promotions` — акции и бонусная программа
- `/cooperation` — партнёрство

Каждая страница получит свой `<title>`, `<meta description>`, и будет индексироваться отдельно. На главной оставить краткие preview-секции со ссылками на подробные страницы.

### B. Performance — Server Components

Сейчас все данные загружаются на клиенте через Supabase JS SDK. Рекомендуется:

- Перенести загрузку данных в Server Components (React 19)
- Использовать `fetch()` + Supabase REST API вместо клиентского SDK для публичных данных
- Это ускорит First Contentful Paint и улучшит SEO (данные в HTML)

### C. Реальные изображения продуктов

Все 22 продукта показывают emoji вместо фото. Для коммерческого сайта это критично:

- Сфотографировать все напитки из автоматов
- Загрузить через уже готовый ImageUpload в админке
- Добавить WebP формат для оптимизации

### D. Error Boundary с fallback UI

Добавить `error.tsx` на уровне `[locale]/` с красивым UI ошибки и кнопкой «Попробовать снова». Локализовать текст.

### E. Loading states (Skeleton UI)

Добавить `loading.tsx` для основных маршрутов с skeleton-заглушками вместо пустого экрана при загрузке данных.

### F. PWA (Progressive Web App)

Добавить `manifest.json` и service worker для:
- Offline-доступа к каталогу и карте автоматов
- Push-уведомлений об акциях
- Установки на домашний экран (особенно актуально для Узбекистана)

### G. Analytics

Подключить аналитику:
- Yandex Metrika (основная для UZ рынка) или Google Analytics
- Отслеживание конверсий (клик «Войти» → Telegram Mini App)
- Heatmaps для понимания поведения пользователей

### H. Тесты

Проект не имеет ни одного теста. Рекомендуется:

- Unit-тесты для `lib/` утилит (Vitest)
- Component-тесты для ключевых компонентов (React Testing Library)
- E2E-тесты для критического пути (Playwright)
- Минимум: тест для форматирования цен, фильтрации продуктов, формы партнёрства

### J. Мониторинг и логирование

- Подключить Sentry для отлова ошибок в production
- Логировать Supabase query errors
- Health-check endpoint для Railway

---

## Итого

| Категория | Количество |
|-----------|-----------|
| Критические проблемы | 6 |
| Важные проблемы | 10 |
| Средние проблемы | 12 |
| Предложения по улучшению | 10 |
| **Всего найдено** | **38** |

Проект в целом хорошо структурирован, TypeScript и ESLint проходят чисто, build успешен. Основные проблемы — в области SEO (sitemap с якорями), i18n (6+ компонентов без перевода), accessibility (отсутствуют ARIA-атрибуты) и мелких багах (пустые options, утечки таймеров).

Рекомендуемый порядок работы: сначала критические фиксы (1-2 дня), затем i18n (2-3 дня), далее accessibility и infrastructure.
