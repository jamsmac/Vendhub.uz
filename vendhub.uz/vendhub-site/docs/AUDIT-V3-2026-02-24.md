# VendHub.uz — Полный аудит V3 (после исправлений)

> **Дата:** 24 февраля 2026
> **Аудитор:** Claude (по запросу Jamshid)
> **Тип:** Полная повторная проверка после массовых доработок
> **Проект:** vendhub-site (Next.js 16 + React 19 + Supabase)
> **Проверено файлов:** 50+ (все компоненты, lib, app, config, i18n, infra)

---

## Результаты автоматических проверок

| Проверка | Статус | Детали |
|----------|--------|--------|
| `next build` | **PASS** | Все страницы собираются, 15 dynamic routes |
| `pnpm lint` (ESLint) | **FAIL — 5 ошибок** | 3 новых ошибки (см. ниже) |
| `tsc --noEmit` | **FAIL — 60+ ошибок** | Тесты не проходят TS (vitest types не в tsconfig) |
| Dependencies | **OK** | 500 пакетов, 0 уязвимостей |

**Предупреждение build:** `middleware.ts` deprecated в Next.js 16.

---

## БЛОКИРУЮЩИЕ ПРОБЛЕМЫ (3)

Эти проблемы ломают CI pipeline и должны быть исправлены **немедленно**.

### Б1. ESLint: Header.tsx — запись в ref во время рендера

**Файл:** `components/sections/Header.tsx`, строка 19
**ESLint rule:** `react-hooks/refs`

```typescript
const isMobileMenuOpenRef = useRef(isMobileMenuOpen)
isMobileMenuOpenRef.current = isMobileMenuOpen // ❌ Cannot update ref during render
```

**Проблема:** React Compiler (React 19) запрещает обновление `ref.current` во время рендера. Это может привести к тому, что компонент не обновится.

**Решение:**
```typescript
// Убрать ref, использовать useEffect для закрытия при скролле:
useEffect(() => {
  const handleScroll = () => {
    setIsScrolled(window.scrollY > 50)
  }
  window.addEventListener('scroll', handleScroll, { passive: true })
  return () => window.removeEventListener('scroll', handleScroll)
}, [])

// Отдельный эффект для закрытия меню при скролле:
useEffect(() => {
  if (!isMobileMenuOpen) return
  const closeOnScroll = () => setIsMobileMenuOpen(false)
  window.addEventListener('scroll', closeOnScroll, { passive: true, once: true })
  return () => window.removeEventListener('scroll', closeOnScroll)
}, [isMobileMenuOpen])
```

---

### Б2. ESLint: Админ-страницы — setState в useEffect

**Файлы:**
- `app/[locale]/admin/cooperation/page.tsx`, строка 64
- `app/[locale]/admin/machine-types/page.tsx`, строка 43

**ESLint rule:** `react-hooks/set-state-in-effect`

```typescript
useEffect(() => {
  fetchRequests() // ❌ fetchRequests() вызывает setState
}, [fetchRequests])
```

**Проблема:** `fetchRequests()` внутри вызывает `setRequests(data)` — это setState внутри useEffect, что React Compiler считает каскадным рендером.

**Решение:** Переписать на inline async:
```typescript
useEffect(() => {
  let cancelled = false
  async function load() {
    setLoading(true)
    const { data } = await supabase.from('cooperation_requests')
      .select('*').order('created_at', { ascending: false })
    if (!cancelled) {
      setRequests(data ?? [])
      setLoading(false)
    }
  }
  load()
  return () => { cancelled = true }
}, [])
```

---

### Б3. TypeScript: Тесты не проходят `tsc --noEmit`

**Файлы:** `tests/geo.test.ts`, `tests/i18n-sync.test.ts`, `tests/imageUpload.test.ts`, `tests/utils.test.ts`

**Проблема:** В `vitest.config.ts` включены `globals: true`, но `tsconfig.json` не содержит reference на vitest типы. TypeScript не знает о `describe`, `it`, `expect`, `vi`.

**Решение A (рекомендуется):** Добавить reference в `tsconfig.json`:
```json
{
  "compilerOptions": {
    "types": ["vitest/globals"]
  }
}
```

**Решение B:** Исключить тесты из tsc:
```json
{
  "exclude": ["node_modules", "tests"]
}
```

**Решение C:** Убрать `globals: true` из vitest и импортировать явно:
```typescript
import { describe, it, expect, vi } from 'vitest'
```

Также в `tests/i18n-sync.test.ts` строки 38, 42: eslint ругается на `@typescript-eslint/no-explicit-any`.

---

## КРИТИЧЕСКИЕ ПРОБЛЕМЫ (5)

### К1. LeafletMap — `useMemo` для побочных эффектов

**Файл:** `components/map/LeafletMap.tsx`, строка 59

```typescript
useMemo(() => {
  // map.fitBounds() и map.setView() — это side effects!
}, [machines, map])
```

**Проблема:** React может пропустить или повторить `useMemo`. Side effects (изменение карты) непредсказуемы.

**Решение:** Заменить на `useEffect`:
```typescript
useEffect(() => {
  const points = machines
    .filter((m) => m.latitude != null && m.longitude != null)
    .map((m) => [m.latitude!, m.longitude!] as L.LatLngTuple)
  if (points.length > 1) {
    map.fitBounds(L.latLngBounds(points), { padding: [40, 40], maxZoom: 14 })
  } else if (points.length === 1) {
    map.setView(points[0], 14)
  }
}, [machines, map])
```

---

### К2. Toast — утечка таймеров при unmount

**Файл:** `components/ui/Toast.tsx`

**Текущее состояние:** Видно что `timersRef` и `useEffect` cleanup уже добавлены — нужно убедиться что cleanup действительно очищает все таймеры. Также `let toastId = 0` на уровне модуля — будет расти бесконечно. Не критично для текущего сайта, но антипаттерн.

---

### К3. not-found.tsx — нет i18n, ссылка без locale

**Файл:** `app/not-found.tsx`

Текст захардкожен билингвально (`"Sahifa topilmadi / Страница не найдена"`), ссылка `href="/"` всегда ведёт на русскую версию.

**Решение:** Определять locale по URL:
```typescript
'use client'
import { useEffect, useState } from 'react'

export default function NotFound() {
  const [isUz, setIsUz] = useState(false)
  useEffect(() => {
    setIsUz(window.location.pathname.startsWith('/uz'))
  }, [])
  const href = isUz ? '/uz' : '/'
  const title = isUz ? 'Sahifa topilmadi' : 'Страница не найдена'
  // ...
}
```

---

### К4. error.tsx — аналогичная проблема с i18n

**Файл:** `app/error.tsx`

Тот же билингвальный хардкод: `"Xatolik yuz berdi / Что-то пошло не так"`.

---

### К5. MachineModal — unsafe non-null assertions

**Файл:** `components/modals/MachineModal.tsx`

```typescript
latitude={machine.latitude!}   // ❌ если null — runtime crash
longitude={machine.longitude!}
```

Даже при проверке `hasCoords`, TypeScript не сужает тип после условия. Нужен explicit guard:
```typescript
{machine.latitude != null && machine.longitude != null && (
  <NavigationSelector
    latitude={machine.latitude}
    longitude={machine.longitude}
    ...
  />
)}
```

---

## ВАЖНЫЕ ПРОБЛЕМЫ (10)

### В1. .env.example — мёртвая переменная YANDEX_MAPS_API_KEY

**Файл:** `.env.example`, строка 3

```
NEXT_PUBLIC_YANDEX_MAPS_API_KEY=your-yandex-maps-key
```

Проект давно не использует Yandex Maps. Вводит в заблуждение.

**Решение:** Удалить строку 3.

---

### В2. Footer — захардкоженные контактные данные

**Файл:** `components/sections/Footer.tsx`, строки 117, 127

```typescript
+998 71 200 39 99  // захардкожено
info@vendhub.uz    // захардкожено
```

В AboutSection контакты уже берутся из i18n (`t('contacts.phoneValue')`), а в Footer — нет.

**Решение:** Использовать те же ключи переводов.

---

### В3. Footer — placeholder ссылки `href="#"`

**Файл:** `components/sections/Footer.tsx`, строки 172, 176

```html
<a href="#">{t('privacy')}</a>
<a href="#">{t('terms')}</a>
```

**Решение:** Создать страницы `/privacy`, `/terms` или временно скрыть.

---

### В4. LeafletMap — inline HTML с event handlers (XSS паттерн)

**Файл:** `components/map/LeafletMap.tsx`, строки 27-36, 78-90

```typescript
html: `<div onmouseenter="this.style.transform='scale(1.2)'" ...>☕</div>`
```

Inline event handlers и `<style>` в строке. Хотя данные контролируемые — это антипаттерн.

**Решение:** Вынести стили в CSS-классы в `globals.css`.

---

### В5. LeafletMap — `attributionControl={false}` нарушает лицензию OSM

**Файл:** `components/map/LeafletMap.tsx`, строка 112

OpenStreetMap **требует** attribution. Отключение может привести к нарушению лицензии ODbL.

**Решение:** Включить обратно: `attributionControl={true}`.

---

### В6. Modal — body overflow не восстанавливается корректно

**Файл:** `components/ui/Modal.tsx`

```typescript
document.body.style.overflow = 'hidden' // при открытии
document.body.style.overflow = ''        // при закрытии — но если было 'scroll'?
```

**Решение:** Сохранять предыдущее значение:
```typescript
const prevOverflow = document.body.style.overflow
document.body.style.overflow = 'hidden'
return () => { document.body.style.overflow = prevOverflow }
```

---

### В7. ProductModal — сравнение опций по ссылке

**Файл:** `components/modals/ProductModal.tsx`

```typescript
aria-pressed={selectedOption === opt} // ← reference equality
```

Если массив `options` пересоздаётся при рендере родителя, выбранная опция «сбрасывается» визуально.

**Решение:** Сравнивать по `opt.name` или `opt.price`.

---

### В8. PartnerForm — телефон не валидирует структуру UZ

**Файл:** `components/partner/PartnerForm.tsx`

```typescript
if (!cleanPhone.match(/^\+998\d{9}$/))
```

Пропускает невалидные номера вроде `+998000000000`.

**Решение:** `^\+998[0-9][0-9]\d{7}$` или точнее `^\+998(9[0-9]|[67][0-9])\d{7}$`.

---

### В9. Данные: 20 продуктов vs 22 в CLAUDE.md

**Файл:** `lib/data.ts` — 20 продуктов
**CLAUDE.md:** "22 реальных продукта"

Нужно синхронизировать. Либо добавить 2 недостающих продукта, либо обновить CLAUDE.md.

---

### В10. Данные: 3 акции vs 4 в CLAUDE.md

**Файл:** `lib/data.ts` — 3 промоакции
**CLAUDE.md:** "4 активные акции"

Аналогично — нужно синхронизировать.

---

## СРЕДНИЕ ПРОБЛЕМЫ (12)

### С1. MachinesSection — сложная логика merge в useMemo

**Файл:** `components/sections/MachinesSection.tsx`

`fallbackMachineTypes` создаётся внутри `useMemo` с зависимостью `[t]`. Функция переводов `t` может менять ссылку при каждом рендере, вызывая пересчёт. Нужно проверить стабильность `t` из next-intl.

### С2. MachinesSection — фильтры без aria-label и role="group"

Кнопки-фильтры (Coffee, Combo, Snack, Cold) не имеют семантической группировки.

### С3. MenuSection — hover cursor для unavailable продуктов

Карточки с `available: false` имеют `cursor-pointer`, вводя в заблуждение.

### С4. PopularProducts / MenuSection — Card с onClick без button semantics

`<div onClick={...}>` без `role="button"` и `tabIndex={0}`. Card компонент добавляет их, но стоит проверить.

### С5. LoyaltyTab — Supabase без error handling

```typescript
const [tiersRes, actionsRes, privsRes] = await Promise.all([...])
// нет проверки .error
```

### С6. LanguageSwitcher — контейнер без role="group"

Кнопки переключения языка не обёрнуты в семантическую группу.

### С7. HeroSection — `suppressHydrationWarning` из-за приветствия по времени

Функция `getGreetingKey()` возвращает разные значения на сервере и клиенте (разное время). Подавление предупреждения — правильно, но стоит задокументировать.

### С8. useProductsData — ProductsContextValue не экспортирован

Тип `ProductsContextValue` определён как interface, но не экспортирован. Другие компоненты не могут его переиспользовать.

### С9. localize.ts — использует `any` вместо generics

```typescript
export function localized(item: any, field: string, locale: string): string
```

Должен использовать generic `<T extends Record<string, unknown>>`.

### С10. CSP — connect-src не включает fonts.googleapis.com

**Файл:** `next.config.ts`

Стили шрифтов загружаются через `<link>` (style-src), но `connect-src` не включает `fonts.googleapis.com`. При strict CSP может блокироваться.

### С11. Все изображения null в fallback-данных

`lib/data.ts` — все продукты/автоматы/партнёры имеют `image_url: null`. Нужно загрузить фото через админку.

### С12. PromotionsTab — `document.execCommand('copy')` deprecated

Fallback для clipboard использует deprecated API. Работает, но в будущем может быть удалён.

---

## НИЗКИЕ ПРОБЛЕМЫ (8)

1. **Badge.tsx** — emoji как сырые Unicode без `role="img"` и `aria-label`
2. **PriceTag.tsx** — валюта захардкожена `'UZS'`, нужно из i18n/context
3. **SectionHeader.tsx** — всегда `<h2>`, нет prop `as` для гибкости
4. **useInView.ts** — каждый инстанс создаёт свой IntersectionObserver
5. **DynamicMap.tsx** — нет error fallback при ошибке загрузки
6. **formatPrice()** — всегда regex, можно заменить на `Intl.NumberFormat`
7. **Docker HEALTHCHECK** — не обрабатывает ECONNREFUSED gracefully
8. **Header** — scroll listener пересоздаётся при каждом toggle меню

---

## БЕЗОПАСНОСТЬ

### Положительные моменты:
- ✅ CSP headers настроены (X-Frame-Options, HSTS, Permissions-Policy)
- ✅ `.env.local` в `.gitignore` (`.env*` исключает все env файлы)
- ✅ Supabase RLS включён (публичный READ, ограниченный WRITE)
- ✅ Image upload с валидацией типа и размера (5MB)
- ✅ `noopener noreferrer` на внешних ссылках
- ✅ Нет hardcoded API ключей в коде

### Найденные риски:
- ⚠️ LeafletMap: inline HTML в `divIcon` (низкий XSS риск — данные контролируемые)
- ⚠️ PartnerForm: `comment` не sanitized перед вставкой в БД (RLS + серверный текст, низкий риск)
- ⚠️ `promo.gradient` используется напрямую в className без валидации
- ⚠️ React Compiler включён без тестового покрытия

---

## ОБНОВЛЁННЫЙ ПЛАН ИСПРАВЛЕНИЙ

### Этап 0 — Блокирующие (CI pipeline) — 30 минут

| # | Задача | Файл |
|---|--------|------|
| 1 | Исправить ref во время рендера | `Header.tsx:19` |
| 2 | Исправить setState в useEffect (2 файла) | `admin/cooperation/page.tsx:64`, `admin/machine-types/page.tsx:43` |
| 3 | Добавить vitest types в tsconfig ИЛИ exclude tests | `tsconfig.json` |
| 4 | Исправить `any` в i18n-sync.test.ts | `tests/i18n-sync.test.ts:38,42` |

### Этап 1 — Критические — 1 день

| # | Задача | Файл |
|---|--------|------|
| 5 | `useMemo` → `useEffect` в FitBounds | `LeafletMap.tsx:59` |
| 6 | Исправить not-found.tsx — определять locale | `app/not-found.tsx` |
| 7 | Исправить error.tsx — определять locale | `app/error.tsx` |
| 8 | Убрать non-null assertions в MachineModal | `MachineModal.tsx` |

### Этап 2 — Важные — 1-2 дня

| # | Задача | Файл |
|---|--------|------|
| 9 | Удалить YANDEX из .env.example | `.env.example:3` |
| 10 | Footer: контакты из i18n | `Footer.tsx:117,127` |
| 11 | Footer: убрать placeholder href="#" | `Footer.tsx:172,176` |
| 12 | Включить attributionControl в LeafletMap | `LeafletMap.tsx:112` |
| 13 | Modal: сохранять/восстанавливать overflow | `Modal.tsx` |
| 14 | ProductModal: сравнение по ID/name | `ProductModal.tsx` |
| 15 | PartnerForm: улучшить regex телефона | `PartnerForm.tsx` |
| 16 | Синхронизировать данные (20 vs 22, 3 vs 4) | `data.ts`, `CLAUDE.md` |

### Этап 3 — Средние — 2-3 дня

| # | Задача | Файл |
|---|--------|------|
| 17 | Вынести LeafletMap стили в CSS | `LeafletMap.tsx`, `globals.css` |
| 18 | Accessibility: aria-label, role="group" | Множественные |
| 19 | LoyaltyTab: error handling для Supabase | `LoyaltyTab.tsx` |
| 20 | CSP: добавить fonts.googleapis.com в connect-src | `next.config.ts` |
| 21 | localize.ts: заменить any на generics | `localize.ts` |
| 22 | Экспортировать ProductsContextValue | `useProductsData.tsx` |

---

## ПРЕДЛОЖЕНИЯ ПО УЛУЧШЕНИЮ

### A. SEO — Отдельные страницы (высокий приоритет)
Сейчас добавлены `/machines/[slug]` страницы для типов автоматов (видно в sitemap). Отлично! Следующий шаг — `/menu`, `/promotions`, `/cooperation` как отдельные SEO-страницы.

### B. Server Components для данных
Перенести загрузку данных (products, machines, promotions) в Server Components. AboutSection уже стал Server Component (`async function` + `getTranslations`) — распространить паттерн.

### C. Реальные изображения
Все продукты показывают emoji. ImageUpload в админке готов — нужно загрузить фото.

### D. Loading states (Skeleton UI)
Добавить `loading.tsx` с skeleton-заглушками для каждого маршрута.

### E. PWA
`manifest.json` + service worker для offline-доступа. Особенно актуально для UZ рынка.

### F. Analytics
Yandex Metrika или GA4 с отслеживанием конверсий.

### G. Тесты
Тесты уже начаты (4 файла!), но:
- Не проходят tsc (нужен fix tsconfig)
- Нет тестов для компонентов (RTL)
- Нет E2E (Playwright)

### H. Мониторинг
Sentry для production + health-check endpoint.

### I. Open Graph images
Добавить `og:image` для Telegram/мессенджеров.

### J. Structured Data расширение
Добавить JSON-LD: `Menu`, `Product`, `Place` для автоматов.

---

## ПРОГРЕСС: V1 → V2 → V3

| Метрика | V1 | V2 | V3 |
|---------|----|----|-----|
| Блокирующие (CI) | 0 | 0 | **3** (новые) |
| Критические | 6 | 3 | **5** |
| Важные | 10 | 7 | **10** |
| Средние | 12 | 8 | **12** |
| Низкие | — | — | **8** |
| **Всего** | **28** | **18** | **38** |

**Примечание:** Количество выросло не потому что стало хуже, а потому что:
1. Добавились **новые файлы** (tests/, localize.ts, geo.ts, machines/[slug]/) — новый код = новые находки
2. ESLint стал строже (React Compiler правила)
3. Аудит V3 глубже — проверялись security, accessibility, performance, types

**Реально исправлено с V1:**
- ✅ Sitemap без якорей (+ динамические страницы machine types)
- ✅ ProductModal fallback для пустых options
- ✅ Yandex Maps → Google Maps в AboutSection
- ✅ AboutSection стал Server Component
- ✅ tel: regex исправлен (`/[^\d+]/g`)
- ✅ IntersectionObserver cleanup в Header
- ✅ Фильтры Snack/Cold скрываются при 0
- ✅ 6+ компонентов переведены на i18n
- ✅ Toast: role="alert", cleanup таймеров
- ✅ Header: aria-expanded, aria-label
- ✅ ProductModal: aria-pressed
- ✅ CATEGORY_GRADIENT вынесен в единый файл
- ✅ YANDEX из Dockerfile и CI удалён
- ✅ PartnerSection: t.raw() с Array.isArray валидацией
- ✅ PartnerSection: убрана прямая зависимость от Supabase (props)
- ✅ PromotionsTab: clipboard fallback, locale-aware formatDate, localized()
- ✅ PopularProducts: localized() для имён продуктов
- ✅ Новые утилиты: localize.ts, geo.ts, categoryStyles.ts, productPresentation.ts
- ✅ Новые тесты (4 файла!)
- ✅ Новые страницы: /machines/[slug]

---

## Итого

Проект **значительно продвинулся**. Ключевые доработки (i18n, локализация данных, Server Components, тесты, SEO-страницы) — серьёзный прогресс.

**Приоритет #1** — исправить 3 блокирующие ошибки ESLint + tsconfig (30 минут работы), чтобы CI/CD pipeline не ломался.

**Приоритет #2** — 5 критических проблем (LeafletMap useMemo, not-found, error.tsx, MachineModal assertions) — 1 день.

Всё остальное можно фиксить итерационно.
